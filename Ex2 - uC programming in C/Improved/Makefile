#############################
# MAKEFILE FOR EX2, TDT4258 #
#############################

# Definition of GNU C compiler (named GCC) to generate object .o file
CC=arm-none-eabi-gcc
# Definition of GNU linker to generate .o file. In C, files can be linked with "-gcc" command, calling later "-ld" automatically.
LD=arm-none-eabi-gcc
# Definition of GNU object copy (named OBJCOPY) to generate binary .bin file
OBJCOPY=arm-none-eabi-objcopy


# Important arguments in "GNU C Compiler (GCC)" commands:
#	-mcpu=cortex-m3: Establishes the M3 instruction set.
#	-Wall: Turn on all warnings. This will generate warnings for considered "bad practise" code in C.
#	-g: Make debug symbols so that program can be debugged with GDB.
#	-c: Make an object file (since we handle linking manually)
#	-o <outputfile.o>: Write result of compiling to file \outputfile.o" (other formats also possible).
#	<inputfile.c>: C file to be compiled.
#	-lgcc -lc -lcs3 -lcs3unhosted: Link to various useful libraries.
#	-lefm32gg: Link to EFM32GG startup code.
#	-Llib: Add lib to the library search path.
CFLAGS=-mcpu=cortex-m3 -mthumb -g -std=c99 -Wall
LDFLAGS=-mcpu=cortex-m3 -mthumb -g -lgcc -lc -lcs3 -lcs3unhosted -lefm32gg -Llib
LINKERSCRIPT=lib/efm32gg.ld


# Get raw binary using the object copy (ex2_Improved.bin generated)
ex2_Improved.bin : ex2_Improved.elf
	${OBJCOPY} -O binary $< $@
# Reagrupates ALL object files using the linker (ex2_Improved.elf generated)
ex2_Improved.elf : ex2_Improved.o timer.o dac.o gpio.o sound.o interrupt_handlers.o
	${LD} -T ${LINKERSCRIPT} $^ -o $@ ${LDFLAGS}
# All source files with .c extension (ex2, timer, dac, gpio, sound, interrupt_handlers) are compiled using the GNU C Compiler (all .o files generated)
%.o : %.c
	${CC} ${CFLAGS} -c $< -o $@


# Command "make upload" created. Applies the Linux kernel coding style on all source files.
.PHONY : pretty
pretty :
	-indent *.c *.h

# Command "make upload" created. Flashes the program "ex2_Improved" onto the board.
.PHONY : upload
upload :
	-eACommander.sh -r --address 0x00000000 -f "ex2_Improved.bin" -r

# Command "make clean" created. Removes all autogenerated files, keeping only source files.
.PHONY : clean
clean :
	-rm -rf *.o *.elf *.bin *.hex